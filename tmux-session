#!/usr/bin/env bash
set -euo pipefail

# tmux-session: Interactive tmux session manager with AI summaries
# Pure bash, zero external dependencies (except tmux, curl, jq for AI features)

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ -d "${SCRIPT_DIR}/lib" ]]; then
    LIB_DIR="${SCRIPT_DIR}/lib"
elif [[ -d "${SCRIPT_DIR}/tmux-session-lib" ]]; then
    LIB_DIR="${SCRIPT_DIR}/tmux-session-lib"
else
    echo "Error: Cannot find lib directory" >&2
    exit 1
fi
source "${LIB_DIR}/constants.sh"
source "${LIB_DIR}/utils.sh"
source "${LIB_DIR}/config.sh"
source "${LIB_DIR}/sessions.sh"
source "${LIB_DIR}/ai.sh"
source "${LIB_DIR}/render.sh"
source "${LIB_DIR}/actions.sh"
source "${LIB_DIR}/input.sh"

# ─── Cleanup and main ────────────────────────────────────────────────

SAVED_TTY=""

cleanup() {
    cursor_show
    clear_screen
    cursor_to 1 1
    cleanup_ai
    if [[ -n "$SAVED_TTY" ]]; then
        stty "$SAVED_TTY" 2>/dev/null || true
    fi
}

main() {
    check_deps
    load_user_config

    # Handle --version / --help
    case "${1:-}" in
        --version|-v) echo "tmux-session v${VERSION}"; exit 0 ;;
        --help|-h)
            echo "tmux-session v${VERSION} - Interactive tmux session manager"
            echo ""
            echo "Usage: tmux-session"
            echo ""
            echo "Keys (list view):"
            echo "  Up/Down  Navigate sessions"
            echo "  Enter    Open session detail view"
            echo "  n        New session"
            echo "  f        Refresh session list + AI summaries"
            echo "  q        Quit"
            echo ""
            echo "Keys (detail view):"
            echo "  Enter/a  Attach to session"
            echo "  r        Rename session (with AI suggestion)"
            echo "  k        Kill session"
            echo "  ESC/q    Back to list"
            echo ""
            echo "Environment:"
            echo "  ANTHROPIC_API_KEY  Set to enable AI summaries (uses Haiku)"
            echo "  TMUX_SESSION_CONFIG_FILE   Override config file path"
            echo "  TMUX_SESSION_NEW_DEFAULT_DIR  Default workdir for new sessions"
            echo "  TMUX_SESSION_NEW_DEFAULT_CMD  Default init command for new sessions"
            echo "  TMUX_SESSION_NEW_ASK_DIR   Ask for workdir each time (1/0)"
            echo "  TMUX_SESSION_NEW_ASK_CMD   Ask for init command each time (1/0)"
            exit 0
            ;;
    esac

    # Save terminal state and setup raw mode
    SAVED_TTY=$(stty -g 2>/dev/null || true)
    trap cleanup EXIT INT TERM
    stty -echo -icanon min 1 time 0 2>/dev/null || true

    cursor_hide
    clear_screen

    refresh_sessions
    start_ai_summaries
    render

    while $RUNNING; do
        if [[ "$VIEW_MODE" == "detail" ]]; then
            handle_detail_input
        else
            handle_input
        fi
        render
    done
}

main "$@"
