#!/usr/bin/env bash
set -euo pipefail

# tmux-session: Interactive tmux session manager with AI summaries
# Pure bash, zero external dependencies (except tmux, curl, jq for AI features)

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/lib/constants.sh"
source "${SCRIPT_DIR}/lib/utils.sh"
source "${SCRIPT_DIR}/lib/sessions.sh"
source "${SCRIPT_DIR}/lib/ai.sh"
source "${SCRIPT_DIR}/lib/render.sh"
source "${SCRIPT_DIR}/lib/actions.sh"
source "${SCRIPT_DIR}/lib/input.sh"

# ─── Cleanup and main ────────────────────────────────────────────────

SAVED_TTY=""

cleanup() {
    cursor_show
    clear_screen
    cursor_to 1 1
    cleanup_ai
    if [[ -n "$SAVED_TTY" ]]; then
        stty "$SAVED_TTY" 2>/dev/null || true
    fi
}

main() {
    check_deps

    # Handle --version / --help
    case "${1:-}" in
        --version|-v) echo "tmux-session v${VERSION}"; exit 0 ;;
        --help|-h)
            echo "tmux-session v${VERSION} - Interactive tmux session manager"
            echo ""
            echo "Usage: tmux-session"
            echo ""
            echo "Keys:"
            echo "  Up/Down  Navigate sessions"
            echo "  Enter    Attach to selected session"
            echo "  r        Rename session (with AI suggestion)"
            echo "  k        Kill session"
            echo "  n        New session"
            echo "  f        Refresh session list + AI summaries"
            echo "  q        Quit"
            echo ""
            echo "Environment:"
            echo "  ANTHROPIC_API_KEY  Set to enable AI summaries (uses Haiku)"
            exit 0
            ;;
    esac

    # Save terminal state and setup raw mode
    SAVED_TTY=$(stty -g 2>/dev/null || true)
    trap cleanup EXIT INT TERM
    stty -echo -icanon min 1 time 0 2>/dev/null || true

    cursor_hide
    clear_screen

    refresh_sessions
    start_ai_summaries
    render

    while $RUNNING; do
        handle_input
        render
    done
}

main "$@"
